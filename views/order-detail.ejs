<%- include('partials/header') %>

<div class="container my-5" style="max-width: 1000px;">
  <h2 class="text-center mb-5 fw-bold" style="color:#7c3aed;">جزئیات سفارش</h2>

  <div class="row g-4">

    <!-- جزئیات سفارش -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm border-0" style="border-top:4px solid #c4b5fd; background:#fafaff;">
        <div class="card-body dir-rtl">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="text-purple fw-bold mb-0">شماره سفارش: <%= order.orderCode %></h5>
            <span class="badge bg-light text-dark border px-3 py-2" style="border-color:#ddd;">
              وضعیت:
              <% if(order.status === 'pending'){ %>
                <span class="text-warning fw-semibold">در انتظار تأیید</span>
              <% } else if(order.status === 'paid'){ %>
                <span class="text-success fw-semibold">پرداخت شده</span>
              <% } else if(order.status === 'shipped'){ %>
                <span class="text-info fw-semibold">ارسال شده</span>
              <% } else if(order.status === 'delivered'){ %>
                <span class="text-success fw-semibold">تحویل داده شده</span>
              <% } else { %>
                <span class="text-danger fw-semibold">لغو شده</span>
              <% } %>
            </span>
          </div>

          <p class="text-muted mb-3">تاریخ ثبت: <%= new Date(order.createdAt).toLocaleDateString('fa-IR') %></p>

          <hr>

          <% order.items.forEach(item => { %>
            <div class="d-flex align-items-start mb-4 p-3 shadow-sm" style="border-radius:12px; background:#ffffff;">
              <div style="width:90px; height:90px; flex:0 0 90px; margin-left:14px;">
                <% if (item.imageUrl) { %>
                  <img src="<%= item.imageUrl %>" alt="<%= item.name %>" style="width:100%; height:100%; object-fit:cover; border-radius:10px; border:2px solid #ddd;">
                <% } else { %>
                  <div style="width:100%; height:100%; background:#f1f1f1; display:flex; align-items:center; justify-content:center; border-radius:8px;">
                    <small class="text-muted">بدون تصویر</small>
                  </div>
                <% } %>
              </div>

              <div class="flex-grow-1">
                <h6 class="mb-2 fw-bold"><%= item.name %></h6>

                <div class="small text-muted mb-2">
                  قیمت واحد:
                  <span class="text-dark fw-semibold"><%= Number(item.unitPrice || 0).toLocaleString() %></span> تومان
                </div>

                <% if (item.selections && item.selections.length > 0) { %>
                  <% item.selections.forEach(sel => { %>
                    <div class="d-flex justify-content-between align-items-center mb-2 bg-light px-3 py-2 rounded-3 border" style="border-color:#e0e0ff;">
                      <div>
                        <span class="badge bg-white text-dark border me-2">
                          <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:<%= sel.colorCode || '#ccc' %>;margin-inline-start:6px;border:1px solid #ddd;"></span>
                          <strong><%= sel.color %></strong>
                        </span>
                        <small class="text-muted"> — <%= sel.packs || 0 %> بسته</small>
                        <small class="text-muted"> — <%= sel.units || (sel.packs * item.packSize) || 0 %> عدد</small>
                      </div>
                      <div class="text-end">
                        <small class="text-muted">قیمت جزء:</small>
                        <div class="fw-bold text-success"><%= Number(sel.subtotal || (sel.packs * item.unitPrice * item.packSize) || 0).toLocaleString() %> تومان</div>
                      </div>
                    </div>
                  <% }) %>
                <% } %>

                <div class="text-end mt-2">
                  <small class="text-muted">قیمت کل این محصول:</small>
                  <div class="fw-bold text-purple"><%= Number(item.totalPrice || 0).toLocaleString() %> تومان</div>
                </div>

              </div>
            </div>
          <% }) %>

          <hr>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">تعداد آیتم‌ها: <strong><%= order.items.length %></strong></small>
            <div class="h5 mb-0">جمع کل:
              <span class="text-purple fw-bold"><%= Number(order.total || 0).toLocaleString() %> تومان</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- اطلاعات گیرنده -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm border-0" style="border-top:4px solid #a78bfa; background:#f8f7ff;">
        <div class="card-body dir-rtl">
          <h5 class="card-title mb-3 text-purple fw-bold">مشخصات گیرنده</h5>
          <p class="mb-1"><strong>نام:</strong> <%= order.firstName || '-' %> <%= order.lastName || '' %></p>
          <p class="mb-1"><strong>تلفن:</strong> <%= order.userId?.mobile || '-' %></p>
          <p class="mb-1"><strong>ایمیل:</strong> <%= order.userId?.email || '-' %></p>
          <hr>
          <p class="mb-1"><strong>آدرس:</strong></p>
          <p class="text-muted"><%= order.address || order.userId?.address || '-' %></p>
          <p class="mb-0"><strong>کدپستی:</strong> <%= order.postalCode || order.userId?.postalCode || '-' %></p>

          <hr>
          <p class="mb-1"><strong>روش پرداخت:</strong>
            <%= order.paymentMethod === 'online' ? 'پرداخت آنلاین' : 'پرداخت در محل' %>
          </p>
          <p class="mb-0"><strong>شماره پیگیری:</strong> <%= order.trackingCode || '—' %></p>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .text-purple { color:#7c3aed; }
  .btn-purple {
    background-color:#8b5cf6;
    border:none;
    color:white;
    transition: all 0.3s ease;
  }
  .btn-purple:hover {
    background-color:#6d28d9;
  }
  .btn-outline-purple {
    color:#7c3aed;
    border:1px solid #7c3aed;
    transition: all 0.3s ease;
  }
  .btn-outline-purple:hover {
    background-color:#7c3aed;
    color:#fff;
  }
</style>

<%- include('partials/footer') %>
