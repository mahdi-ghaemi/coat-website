<%- include("partials/header.ejs") %>

<main class="container my-5 ">
  <h1 class="mb-4 fw-bold text-center">ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§</h1>

  <% if (!cart || cart.length === 0) { %>
    <div class="alert alert-info text-center shadow-sm rounded-3 py-4">
      Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª ğŸ˜¢
    </div>
  <% } else { %>
    <div class="row g-4 dir-rtl ">
      <% cart.forEach((item, idx) => { %>
        <div class="col-12">
          <div class="card shadow-sm border-0 rounded-4 p-3">
            <div class="row align-items-center g-3">
              <div class="col-md-3 text-center">
                <img src="<%= item.imageUrl %>" alt="<%= item.name %>"
                  class="img-fluid rounded-4 border" style="max-height: 160px; object-fit: cover;">
              </div>

              <div class="col-md-6">
                <h5 class="fw-bold mb-3"><%= item.name %></h5>

                <% const colorMap = {
                    "Ù‚Ø±Ù…Ø²": "#ff0000", "Ø¢Ø¨ÛŒ": "#007bff", "Ø³Ø¨Ø²": "#28a745", "Ø²Ø±Ø¯": "#ffc107",
                    "Ù…Ø´Ú©ÛŒ": "#000000", "Ø³ÙÛŒØ¯": "#ffffff", "ØµÙˆØ±ØªÛŒ": "#ff69b4", "Ø¨Ù†ÙØ´": "#6f42c1",
                    "Ù†Ø§Ø±Ù†Ø¬ÛŒ": "#fd7e14", "Ø·ÙˆØ³ÛŒ": "#6c757d", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ": "#8b4513", "Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ": "#001f3f"
                };
                item.selections = item.selections.map(sel => ({
                    ...sel, colorCode: colorMap[sel.color] || sel.color
                })); %>

                <% item.selections.forEach((sel, selIndex) => { %>
                <form
                  action="/cart/update/<%= idx %>/<%= selIndex %>"
                  method="POST"
                  class="update-form d-flex align-items-center flex-wrap mb-2 p-2 rounded bg-light shadow-sm"
                  data-item-index="<%= idx %>"
                  data-sel-index="<%= selIndex %>"
                >
                  <span
                    style="display:inline-block; width:18px; height:18px; border-radius:50%;
                    background-color:<%= sel.colorCode || sel.color || '#ccc' %>;
                    margin-left:8px; border:1px solid #aaa;"
                  ></span>
                  <strong class="me-2"><%= sel.color %></strong>
                  <input type="number" name="packs" value="<%= sel.packs %>" min="1"
                    class="form-control form-control-sm text-center packs-input mx-2"
                    style="width:80px;">
                  <button type="submit" class="btn btn-sm btn-outline-primary">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                </form>
                <% }) %>

                <div class="mt-2 text-muted small">
                  Ù‡Ø± Ø¨Ø³ØªÙ‡: <%= item.packSize %> Ø¹Ø¯Ø¯ â€” 
                  ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ÙˆØ§Ø­Ø¯Ù‡Ø§: <%= item.totalUnits %>
                </div>
              </div>

              <div class="col-md-3 text-start">
                <div class="text-secondary small mb-1">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯:</div>
                <div class="fw-semibold mb-2"><%= item.unitPrice.toLocaleString() %> ØªÙˆÙ…Ø§Ù†</div>

                <div class="h5 text-success mb-2">
                  <strong id="total-price-<%= idx %>">
                    <%= item.totalPrice.toLocaleString() %>
                  </strong> ØªÙˆÙ…Ø§Ù†
                </div>

                <form action="/cart/remove/<%= idx %>" method="POST" style="display:inline;">
                  <button class="btn btn-sm btn-danger" onclick="return confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')">
                    Ø­Ø°Ù
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <!-- Ø¬Ù…Ø¹ Ú©Ù„ Ø³Ø¨Ø¯ -->
     
        <div class=" mt-5 text-start border-top pt-4">

          <% const grandTotal = cart.reduce((s, it) => s + (it.totalPrice || 0), 0); %>
          <h4 class="fw-bold">
            Ø¬Ù…Ø¹ Ú©Ù„:
            <span id="grand-total" class="text-success"><%= grandTotal.toLocaleString() %></span> ØªÙˆÙ…Ø§Ù†
          </h4>

          <div class="row mt-3 g-2">  
            <div class="col-12 col-md-3">
              <a href="/checkout" class="btn btn-purple btn-lg w-100">Ø§Ø¯Ø§Ù…Ù‡ Ùˆ ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨</a>
            </div>
            <div class="col-12 col-md-3">
              <a href="/products" class="btn btn-outline-purple btn-lg w-100">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</a>
            </div>
          </div>


        </div>
      
        



  <% } %>
</main>


<style>
  .text-purple { color:#7c3aed; }
  .btn-purple {
    background-color:#8b5cf6;
    border:none;
    color:white;
    transition: all 0.3s ease;
  }
  .btn-purple:hover {
    background-color:#6d28d9;
  }
  .btn-outline-purple {
    color:#7c3aed;
    border:1px solid #7c3aed;
    transition: all 0.3s ease;
  }
  .btn-outline-purple:hover {
    background-color:#7c3aed;
    color:#fff;
  }
</style>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const forms = document.querySelectorAll('.update-form');

  forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const itemIndex = form.dataset.itemIndex;
      const selIndex = form.dataset.selIndex;
      const packs = form.querySelector('.packs-input').value;

      try {
        const res = await fetch(`/cart/update/${itemIndex}/${selIndex}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ packs: Number(packs) })
        });

        const data = await res.json();

        if (data.success) {
          // ğŸ”¹ Ù‚ÛŒÙ…Øª Ø¢ÛŒØªÙ…
          const totalPriceEl = document.querySelector(`#total-price-${itemIndex}`);
          if (totalPriceEl) totalPriceEl.textContent = data.itemTotalPrice.toLocaleString();

          // ğŸ”¹ Ø¬Ù…Ø¹ Ú©Ù„
          const grandTotalEl = document.querySelector('#grand-total');
          if (grandTotalEl) grandTotalEl.textContent = data.grandTotal.toLocaleString();
        } else {
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ');
        }
      } catch (err) {
        console.error(err);
        alert('Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
      }
    });
  });
});
</script>

<%- include("partials/footer.ejs") %>
